---
# Create up challenge files directory on server.
- name: Creating challenge destination directory
  file:
    dest: "{{ server_location }}"
    state: directory
    owner: "{{ http_challenge_user }}"
    group: "{{ http_challenge_group }}"
    mode: "{{ http_challenge_folder_mode }}"
  become: "{{ http_become }}"
  tags:
  - issue-tls-certs-newkey
  - issue-tls-certs

# Create challenge files on server.
- name: "Copying challenge files for domains {{ ', '.join(domains) }}"
  copy:
    dest: "{{ [server_location, item.value[challenge].resource[('.well-known/acme-challenge/'|length):]] | path_join }}"
    content: "{{ item.value[challenge].resource_value }}"
    owner: "{{ http_challenge_user }}"
    group: "{{ http_challenge_group }}"
    mode: "{{ http_challenge_file_mode }}"
  with_dict: "{{ lets_encrypt_challenge.challenge_data }}"
  become: "{{ http_become }}"
  tags:
  - issue-tls-certs-newkey
  - issue-tls-certs
